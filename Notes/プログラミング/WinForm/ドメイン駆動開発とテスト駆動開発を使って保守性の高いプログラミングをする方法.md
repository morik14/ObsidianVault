---
tags:
  - プログラミング
  - CSharp
  - データベース
  - WinForm
---
# ドメイン駆動開発とテスト駆動開発を使って保守性の高いプログラミングをする方法

## いいコードと悪いコード

いいコードと悪いコードの指標は保守性とテスト容易性があること
ドメイン駆動開発で保守性、テスト駆動開発でテスト容易性を向上させる

### コードの段階

第一段階：言語仕様の知識のみ
第二段階：共通化を意識したコーディング

### テストしやすいコード 

どこにも依存していない関数
外部にアクセスするコードはテストしづらい
テストのためにアクセスレベルを変更するのは誤り

## ドメインロジックとクライアントコード

ロジックにはは2種類ある
使う側のコードと使われる側のコード
クライアントコードとアプリケーションロジック
DomainとInfrastructureがドメインコード（ビジネスコード）
ViewとViewModelがクライアントコード

### クライアントに知識があってはならない

クライアントに知識があると永遠に楽にならないコードになる
値とロジックが別の場所にあると、クライアントコードでそれを結び付ける作業が必要になる

### ViewとViewModel

画面をViewとViewModelに分けて、ViewModelをテストし、ViewModelとViewをデータバインドする
「1.2234」は計測値だから「2桁で丸めて、単位にm/sをつける」という知識はViewModelで処理しない
ViewModelの仕事は「選ぶ」ということ

## テストコードをどう書くか

### ViewModelとドメイン層に対して、できるだけカバレッジを上げる

クラス一つ一つをテストするより、シーケンスをつかさどるViewModelをテストするのが一番効果的
多くの分岐があるドメインロジッククラスがあれば、それのみ個別でテストする
絶対に通らない本番コード用のコンストラクタなどをがあるので90%異常が目安
NugetでOpenCoverを取得し、拡張機能のOpenCoverUIで計測する

## 依存関係とは

どのプロジェクトがどのプロジェクトを参照するかの関係 
参照関係は一方向にしか行えない
WindowsFormsからWPFへの移行など、時代とともに進化していく部分と、純粋なCSharp のビジネスロジックを分離してコーディングする

![[Pasted image 20240506182548.png]]

### Domain プロジェクト 

純粋にプレーンなCSharp のコードのみ
どこも参照しない

### Infrastructure プロジェクト

外部との接触部分
Domain を参照する
外部との接触部分はテストコードからテストしづらい

### WinFormプロジェクト

時代によって変化が必要な部分 
Domain とInfrastructure を参照する

### Application層は必要か

省略してもいい

### 参照の追加

プロジェクト→「参照」を右クリック→参照の追加

## フォルダー構成

### Domain のフォルダー構成 

Entities とValueObjectsとRepositoryがドメイン駆動開発の肝

![[Pasted image 20240506203632.png]]

### Infrastructure フォルダー構成

本番とFakeの切り替えがFactoryパターン

![[Pasted image 20240506204831.png]]

### WinForm のフォルダー構成 

UI層という

![[Pasted image 20240506205248.png]]

### Testsのフォルダー構成 

本番コードと同じフォルダ名でテストーコードを書く
Infrastructure のテストはMoqを使う
テストコードを書きやすくしてくれる、ChainingAssertionがおすすめ

![[Pasted image 20240506211010.png]]
### MVVMパターンの適応

View ,ViewModel ,Modelの3つに分けて実装するパターン 
ModelはDomain 層とInfrastructure 層が担っている

ある程度ドメインを作成した後に、それをもとにデータベースを設計すれば、プロトタイプも同時に出来上がる
Fakeを使うことでInfrastructure 層の実装を遅らせる

ViewModelBaseのOnPropertyChangedを呼んでView側に変更通知する
ViewModelBaseのSetPropertyを使う

ファクトリーパターン
クラスの生成を間違いなく行ってくれるクラス
すべてのコードをFactoriesで生成するように強制してするには、Infrastructure のクラスは基本Internalにし、Factories をpublicにする

## デバッグとリリース

お客さんにはリリースでコンパイルしたものを提供する

### DEBUGモード

シャープifデバッグ 

### 外部設定ファイルの値で判断する

configファイルを編集→exe実行

## ValueObjects 

イコールの問題
クラスのイコールはアドレスを比較するので、同じ値を比較してもイコールにならない